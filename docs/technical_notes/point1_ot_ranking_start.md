# 第1点开始文档：OT 排序退化问题

时间：2026-02-27
负责人：Codex

## 目标
修复跨文化推荐中 OT 候选排序信号退化为近常数的问题，确保推荐分数能够真实反映候选与用户历史在 `za` 空间中的对齐差异。

## 问题描述
当前实现在 `recommend_ot` 中将候选分数定义为 `plan.sum(dim=0)`。
在平衡 OT + 固定目标边际 `b` 的设置下，列和理论上应接近 `b`，因此候选分数会接近常数，导致排序失真。

关键位置：
- `dcas/recommender.py` 第 69-76 行附近

## 已确认的基线现象
在 toy 模型上实测（`k=20`）：
- `score` 的唯一值数量极低（近似相同，仅有浮点误差）
- 这说明排序主要由数值噪声驱动，而非真实偏好差异

## 修复思路（本次）
- 保留 Sinkhorn 传输计划 `plan`
- 将候选分数从“列边际质量”替换为“列条件平均运输代价”的负向软最大化：
  - `avg_cost_j = sum_i plan_ij * cost_ij / sum_i plan_ij`
  - `score_j = softmax(-avg_cost_j)`
- 这样在固定 `b` 的前提下，排序仍可由 `cost` 与 `plan` 的结构差异驱动。

## 验收标准
1. 推荐分数不再近常数（同一请求下有显著区分度）
2. 推荐 CLI 正常运行
3. 代码逻辑与文档保持一致
